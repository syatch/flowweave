**Note:** The MD files under `docs/` were generated by AI and partially edited by developers.　They may contain some inaccuracies.

# FlowWeave Developer Documentation

## 1. Overview

**FlowWeave** is a YAML-based task flow execution engine built on **Prefect**.

**Key Features:**

- Prefect as the execution backend
- Stages are executed **serially**
- Tasks can form a **DAG**
- Supports all combinations of global options
- Dynamic module loading for tasks
- Unified logging via `FlowMessage`

---

## 2. Execution Hierarchy

```
Flow
 └─ Stage (serial)
     └─ Task (DAG)
```

| Level | Description |
|-------|------------|
| Flow  | Entire execution defined in a YAML file |
| Stage | Phase-level grouping of tasks |
| Task  | Smallest executable unit |

---

## 3. Flow Execution

### Entry Point

```python
FlowWeave.run(setting_file, parallel=False, show_log=False)
```

### Execution Steps

1. Load YAML & validate against JSONSchema
2. Generate `op` dictionary (dynamic module loading)
3. Generate all combinations for `global_option`
4. Execute Flow for each combination

---

## 4. Global Options

### Purpose
Execute the flow with all combinations of global parameters.

### Example

```yaml
global_option:
  "stage1,stage2":
    db:
      host: [A, B]
      port: [1111, 2222]
```

→ Executes 4 flows (2 hosts × 2 ports)

---

## 5. Stage Execution

- Execution order follows the `flow:` sequence in YAML
- No parallel execution within stages
- Failure handling:
  - Any task returning FAIL sets Stage result to FAIL
  - Subsequent tasks **continue execution**

---

## 6. Task Execution Model

### DAG Example

```yaml
taskA:
  chain:
    next: taskB
taskB:
  chain:
    next: taskC
```

### Execution Rules

- Start from **head tasks**
- Recursively execute linked tasks
- Detect cycles using a `visited` set
- Use `Prefect.task.submit` for async execution

---

## 7. Task Option Resolution Priority

```
default_option
   ↓
global_option (stage-specific)
   ↓
task-specific option
```

Later options **override earlier ones**

---

## 8. `do_only` Execution Control

| Value       | Execution Condition                          |
|------------|---------------------------------------------|
| pre_success | Execute only if previous task succeeded    |
| pre_fail    | Execute only if previous task failed       |
| None        | Always execute                             |

---

## 9. Task Module Requirements

Each `op` must implement:

```python
class Task:
    @staticmethod
    def runner():
        return TaskInstance()
```

`TaskInstance` must implement `__call__()`:

```python
def __call__(self) -> Result:
    return Result.SUCCESS
```

---

## 10. Return Values

**Task:**

```python
{
  "name": task_name,
  "option": option_dict,
  "result": Result
}
```

**Stage:**

```
Result
```

**Flow:**

```
[Result, Result, ...]  # One per global_option combination
```

---

## 11. Logging

| Type                  | Method                     |
|-----------------------|---------------------------|
| Flow / Stage / Task    | `FlowMessage`             |
| Debug                 | Prefect logger            |
| Error                 | `FlowMessage.error`       |

Set `show_log=False` to disable Prefect debug logs.

---

## 12. Error Handling

| Error Type               | Behavior                                           |
|--------------------------|--------------------------------------------------|
| Task exception           | Mark task as FAIL but continue Stage execution  |
| Missing op module        | Raise exception and stop execution immediately |
| Invalid YAML             | Stop execution immediately                      |
| DAG cycle detected       | Raise exception and stop execution             |

---

## 13. Parallelism

| Level   | Parallel |
|---------|----------|
| Flow    | Yes (per `global_option`) |
| Stage   | No       |
| Task    | According to DAG dependencies |

---

## 14. Cycle Detection

- Uses a `visited` set per task execution path
- Revisit of a task in the same path triggers an exception

---

## 15. Use Cases

- Batch processing pipelines
- Experiment condition exploration
- Machine learning preprocessing
- Data transformation flows
- CI/CD workflows

---

## 16. Timeout & Retry (Prefect)

### Timeout

```python
@task(timeout_seconds=300)
def my_task(...):
    ...
```

- `timeout_seconds` defines max runtime
- Task will fail if runtime exceeds limit

### Retry

```python
@task(retries=3, retry_delay_seconds=60)
def my_task(...):
    ...
```

- `retries`: number of automatic retries
- `retry_delay_seconds`: wait time between retries
- Task retries are triggered on **exceptions** or **FAIL results**

---

## 17. Recommended GitHub Structure

```
.
├─ flowweave/
│  ├─ __init__.py
│  ├─ flowweave.py
│  ├─ base.py
│  ├─ message.py
│  └─ schema/
│     ├─ flow.json
│     └─ op_code.json
├─ task/
│  └─ my_task/
│     ├─ op_code.yml
│     └─ my_task.py
└─ FLOWWEAVE_DOC.md
```

---
